# Power BI Dashboard Guide

This document covers creating the retail sales forecasting dashboard in Power BI.

## Dashboard Overview

The dashboard consists of 5 pages, each focused on a specific analytical view:

```
┌─────────────────────────────────────────────────────────────┐
│                    RETAIL FORECAST DASHBOARD                 │
├─────────────────────────────────────────────────────────────┤
│  Page 1: Executive Summary                                   │
│  ├── KPI Cards (Current Month, YoY Growth, Forecast)        │
│  ├── Trend Line Chart                                        │
│  └── Next Month Prediction with Confidence                   │
├─────────────────────────────────────────────────────────────┤
│  Page 2: Historical Analysis                                 │
│  ├── Monthly Sales by Year (Clustered Column)               │
│  ├── Year-over-Year Growth Rate                              │
│  └── Cumulative Sales Comparison                            │
├─────────────────────────────────────────────────────────────┤
│  Page 3: Forecast Detail                                     │
│  ├── Forecast with 80% and 95% Confidence Bands             │
│  ├── Actual vs Predicted Comparison                          │
│  └── Forecast Table with Details                            │
├─────────────────────────────────────────────────────────────┤
│  Page 4: Seasonality Analysis                                │
│  ├── Monthly Pattern (Average by Month)                      │
│  ├── Yearly Seasonality Decomposition                        │
│  └── Holiday Impact Analysis                                 │
├─────────────────────────────────────────────────────────────┤
│  Page 5: Model Performance & Why Predictions Fail            │
│  ├── Error Distribution                                      │
│  ├── Anomaly Detection Table                                 │
│  └── Error Explanations                                      │
└─────────────────────────────────────────────────────────────┘
```

## Data Model

### Data Sources

1. **retail_sales_clean.parquet** - Historical sales data
2. **forecast_latest.csv** - Prophet predictions
3. **error_analysis.csv** - Error explanations (generated by Python)

### Import Data into Power BI

1. Open Power BI Desktop
2. Get Data > Parquet (for .parquet files) or Text/CSV (for .csv)
3. Select files from `data/processed/` and `data/predictions/`

### Relationships

```
┌──────────────────┐       ┌──────────────────┐
│  retail_sales    │       │    forecast      │
├──────────────────┤       ├──────────────────┤
│  ds (Date)       │──────▶│  ds (Date)       │
│  y (Sales)       │       │  yhat            │
│  category_code   │       │  yhat_lower_80   │
│  year            │       │  yhat_upper_80   │
│  month           │       │  yhat_lower_95   │
│  is_holiday_month│       │  yhat_upper_95   │
└──────────────────┘       │  trend           │
                           │  yearly          │
                           └──────────────────┘
```

Create relationship:
- Table: `retail_sales` → `forecast`
- Column: `ds` → `ds`
- Cardinality: One-to-One
- Cross filter: Both

### Date Table

Create a dedicated date table for time intelligence:

```dax
DateTable =
ADDCOLUMNS(
    CALENDAR(DATE(2015,1,1), DATE(2030,12,31)),
    "Year", YEAR([Date]),
    "Month", MONTH([Date]),
    "MonthName", FORMAT([Date], "MMMM"),
    "Quarter", "Q" & FORMAT([Date], "Q"),
    "YearMonth", FORMAT([Date], "YYYY-MM"),
    "IsCurrentMonth", IF(
        YEAR([Date]) = YEAR(TODAY()) && MONTH([Date]) = MONTH(TODAY()),
        TRUE, FALSE
    ),
    "IsForecast", IF([Date] > MAX(retail_sales[ds]), TRUE, FALSE)
)
```

## DAX Measures

### Basic Measures

```dax
// Total Sales
Total Sales = SUM(retail_sales[y])

// Current Month Sales
Current Month Sales =
CALCULATE(
    [Total Sales],
    FILTER(
        retail_sales,
        retail_sales[ds] = MAX(retail_sales[ds])
    )
)

// Previous Month Sales
Previous Month Sales =
CALCULATE(
    [Total Sales],
    DATEADD(DateTable[Date], -1, MONTH)
)

// Year-over-Year Growth
YoY Growth % =
VAR CurrentYear = [Total Sales]
VAR PreviousYear = CALCULATE([Total Sales], SAMEPERIODLASTYEAR(DateTable[Date]))
RETURN
DIVIDE(CurrentYear - PreviousYear, PreviousYear, 0) * 100
```

### Forecast Measures

```dax
// Forecast Value
Forecast = SUM(forecast[yhat])

// Forecast Lower 80%
Forecast Lower 80 = SUM(forecast[yhat_lower_80])

// Forecast Upper 80%
Forecast Upper 80 = SUM(forecast[yhat_upper_80])

// Forecast Lower 95%
Forecast Lower 95 = SUM(forecast[yhat_lower_95])

// Forecast Upper 95%
Forecast Upper 95 = SUM(forecast[yhat_upper_95])

// Next Month Forecast
Next Month Forecast =
VAR LastActualDate = MAX(retail_sales[ds])
VAR NextMonth = EDATE(LastActualDate, 1)
RETURN
CALCULATE(
    SUM(forecast[yhat]),
    forecast[ds] = NextMonth
)
```

### Error Analysis Measures

```dax
// Forecast Error
Forecast Error =
VAR Actual = SUM(retail_sales[y])
VAR Predicted = SUM(forecast[yhat])
RETURN
Actual - Predicted

// MAPE (Mean Absolute Percentage Error)
MAPE =
VAR ErrorTable =
    ADDCOLUMNS(
        SUMMARIZE(retail_sales, retail_sales[ds]),
        "AbsPctError",
        ABS(
            DIVIDE(
                CALCULATE(SUM(retail_sales[y])) - CALCULATE(SUM(forecast[yhat])),
                CALCULATE(SUM(retail_sales[y])),
                0
            )
        )
    )
RETURN
AVERAGEX(ErrorTable, [AbsPctError]) * 100

// Within Confidence Band
Within 95% CI =
VAR Actual = SUM(retail_sales[y])
VAR Lower = SUM(forecast[yhat_lower_95])
VAR Upper = SUM(forecast[yhat_upper_95])
RETURN
IF(Actual >= Lower && Actual <= Upper, 1, 0)

// Coverage Rate
Coverage Rate =
DIVIDE(
    COUNTROWS(FILTER(retail_sales, [Within 95% CI] = 1)),
    COUNTROWS(retail_sales),
    0
) * 100
```

### Conditional Formatting Measures

```dax
// KPI Color (Green/Red based on YoY)
YoY Color =
IF([YoY Growth %] >= 0, "#2E7D32", "#C62828")

// Error Severity Color
Error Severity =
VAR AbsError = ABS([Forecast Error])
VAR AvgSales = AVERAGE(retail_sales[y])
VAR ErrorPct = DIVIDE(AbsError, AvgSales, 0)
RETURN
SWITCH(
    TRUE(),
    ErrorPct < 0.05, "#4CAF50",  // Green - Low error
    ErrorPct < 0.10, "#FF9800",  // Orange - Medium error
    "#F44336"                     // Red - High error
)
```

## Page-by-Page Design

### Page 1: Executive Summary

**Layout:**
```
┌─────────────────────────────────────────────────────────────┐
│  [Logo]        RETAIL SALES FORECAST         [Last Updated] │
├──────────┬──────────┬──────────┬──────────────────────────┤
│   KPI    │   KPI    │   KPI    │                          │
│ Current  │   YoY    │   Next   │    TREND LINE CHART      │
│  Month   │  Growth  │  Month   │                          │
│  $75.2B  │  +3.2%   │  $77.1B  │    (Area chart with      │
│          │          │ ±$2.3B   │    confidence bands)      │
├──────────┴──────────┴──────────┴──────────────────────────┤
│                                                             │
│              MONTHLY SALES BAR CHART                        │
│              (Last 12 months with forecast highlighted)     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Visuals:**

1. **KPI Cards** (3x)
   - Current Month Sales
   - YoY Growth %
   - Next Month Forecast with confidence range

2. **Trend Line Chart**
   - X-axis: Date
   - Y-axis: Sales
   - Lines: Actual (solid), Forecast (dashed)
   - Area: 95% confidence band

3. **Bar Chart**
   - Last 12 months + next 6 months forecast
   - Color-coded: Historical (blue), Forecast (lighter blue)

### Page 2: Historical Analysis

**Layout:**
```
┌─────────────────────────────────────────────────────────────┐
│                    HISTORICAL ANALYSIS                       │
├──────────────────────────────────┬──────────────────────────┤
│                                  │                          │
│   MONTHLY SALES BY YEAR          │   YEAR-OVER-YEAR         │
│   (Clustered Column Chart)       │   GROWTH TREND           │
│   - One color per year           │   (Line Chart)           │
│   - X-axis: Month                │                          │
│                                  │                          │
├──────────────────────────────────┴──────────────────────────┤
│                                                             │
│              CUMULATIVE SALES BY YEAR                        │
│              (Line chart - running total per year)          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Visuals:**

1. **Clustered Column Chart**
   - X-axis: Month (Jan-Dec)
   - Y-axis: Sales
   - Legend: Year
   - Shows seasonality patterns across years

2. **Line Chart - YoY Growth**
   - X-axis: Month
   - Y-axis: Growth %
   - Shows which months typically have positive/negative growth

3. **Running Total Line**
   - Compare cumulative progress through the year

### Page 3: Forecast Detail

**Layout:**
```
┌─────────────────────────────────────────────────────────────┐
│                    FORECAST DETAIL                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   FORECAST WITH CONFIDENCE BANDS                            │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                    ████████████                      │   │
│   │                ████████████████████                  │   │
│   │     ●●●●●●●●████████████████████████████            │   │
│   │  ●●●        ████████████████████████████████        │   │
│   │             (Actual points, forecast line, bands)    │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
├──────────────────────────────────┬──────────────────────────┤
│   ACTUAL VS PREDICTED            │   FORECAST TABLE         │
│   (Scatter plot - should be      │   Month | Forecast | CI  │
│    along 45° line if accurate)   │   Jan   | $75.2B  | ±2.1 │
│                                  │   Feb   | $76.4B  | ±2.3 │
│                                  │   ...                    │
└──────────────────────────────────┴──────────────────────────┘
```

**Power BI Custom Visual: Confidence Bands**

Use the built-in area chart or the "Line and Clustered Column Chart":

```
Fields:
- X-axis: ds
- Y-axis values:
  1. yhat_lower_95 (area fill)
  2. yhat_lower_80 (area fill)
  3. yhat (line)
  4. yhat_upper_80 (area fill)
  5. yhat_upper_95 (area fill)
  6. y (actual - dots)
```

### Page 4: Seasonality Analysis

**Layout:**
```
┌─────────────────────────────────────────────────────────────┐
│                  SEASONALITY ANALYSIS                        │
├──────────────────────────────────┬──────────────────────────┤
│                                  │                          │
│   MONTHLY PATTERN                │   HOLIDAY IMPACT         │
│   (Column chart - avg by month)  │   (Cards showing % lift) │
│                                  │                          │
│   ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████      │   Thanksgiving: +18%     │
│   Jan        ...        Dec      │   Christmas: +22%        │
│                                  │   July 4th: +5%          │
│                                  │                          │
├──────────────────────────────────┴──────────────────────────┤
│                                                             │
│   PROPHET SEASONALITY COMPONENT                              │
│   (Line chart showing yearly[t] from Prophet output)        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**DAX for Monthly Pattern:**

```dax
Avg Sales by Month =
AVERAGEX(
    VALUES(retail_sales[ds]),
    [Total Sales]
)
```

**DAX for Holiday Lift:**

```dax
Thanksgiving Lift =
VAR NovSales = CALCULATE([Total Sales], MONTH(retail_sales[ds]) = 11)
VAR AvgSales = AVERAGEX(ALL(retail_sales), [Total Sales])
RETURN
DIVIDE(NovSales - AvgSales, AvgSales, 0) * 100
```

### Page 5: Model Performance (Why Predictions Fail)

**This is the KEY DIFFERENTIATOR page.**

**Layout:**
```
┌─────────────────────────────────────────────────────────────┐
│             WHY PREDICTIONS FAIL                             │
├──────────────────────────────────┬──────────────────────────┤
│                                  │                          │
│   ERROR DISTRIBUTION             │   ERROR BY CATEGORY      │
│   (Histogram of errors)          │   (Donut chart)          │
│                                  │   - Normal: 72%          │
│   Distribution should be         │   - Holiday: 15%         │
│   centered around 0              │   - COVID: 10%           │
│                                  │   - Trend: 3%            │
├──────────────────────────────────┴──────────────────────────┤
│                                                             │
│   ANOMALY TABLE                                              │
│   ┌──────────┬────────┬────────┬──────────┬──────────────┐ │
│   │   Date   │ Actual │Forecast│  Error   │ Explanation  │ │
│   ├──────────┼────────┼────────┼──────────┼──────────────┤ │
│   │ Mar 2020 │ $85.2B │ $72.0B │  +$13.2B │ COVID surge  │ │
│   │ Nov 2020 │ $92.1B │ $88.0B │  +$4.1B  │ Holiday peak │ │
│   │ Jun 2022 │ $71.2B │ $74.5B │  -$3.3B  │ Inflation... │ │
│   └──────────┴────────┴────────┴──────────┴──────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Create Error Analysis Table:**

This requires the `error_analysis.csv` generated by the Python forecaster.

If not available, create in Power BI:

```dax
Error Category =
VAR ErrorValue = [Forecast Error]
VAR AbsError = ABS(ErrorValue)
VAR StdError = CALCULATE(STDEV.P(retail_sales[y] - forecast[yhat]), ALL(retail_sales))
VAR CurrentDate = MAX(retail_sales[ds])
RETURN
SWITCH(
    TRUE(),
    CurrentDate >= DATE(2020,3,1) && CurrentDate <= DATE(2021,6,1) && AbsError > StdError, "COVID Impact",
    MONTH(CurrentDate) IN {11, 12} && AbsError > StdError, "Holiday Effect",
    AbsError > 2 * StdError, "Trend Shift",
    "Normal"
)
```

## Formatting & Theme

### Color Palette

| Element | Color | Hex |
|---------|-------|-----|
| Primary (Actual) | Blue | #1976D2 |
| Secondary (Forecast) | Light Blue | #64B5F6 |
| Confidence Band 95% | Very Light Blue | #E3F2FD |
| Confidence Band 80% | Light Blue | #BBDEFB |
| Positive | Green | #4CAF50 |
| Negative | Red | #F44336 |
| Warning | Orange | #FF9800 |
| Background | Light Gray | #FAFAFA |
| Text | Dark Gray | #212121 |

### Create Theme JSON

Save as `retail_forecast_theme.json`:

```json
{
    "name": "Retail Forecast",
    "dataColors": [
        "#1976D2",
        "#64B5F6",
        "#4CAF50",
        "#FF9800",
        "#F44336",
        "#9C27B0"
    ],
    "background": "#FAFAFA",
    "foreground": "#212121",
    "tableAccent": "#1976D2",
    "visualStyles": {
        "*": {
            "*": {
                "fontFamily": "Segoe UI",
                "fontSize": "12px"
            }
        }
    }
}
```

Import: View > Themes > Browse for themes

### Title Formatting

- **Page titles:** Segoe UI Semibold, 24pt, Dark Gray
- **Visual titles:** Segoe UI, 14pt, Dark Gray
- **KPI values:** Segoe UI Bold, 32pt, Primary Blue

## Export Options

### Static Export for GitHub Pages

1. **Screenshots (PNG)**
   - File > Export > Export to PDF (then convert to PNG)
   - Or use Windows Snipping Tool / macOS Screenshot

2. **PDF Report**
   - File > Export > Export to PDF
   - Select pages to include

3. **PowerPoint**
   - File > Export > Export to PowerPoint
   - Good for embedding in portfolio presentations

### Interactive Options

1. **Publish to Web** (if data is public)
   - File > Publish > Publish to web
   - Get embed code for GitHub Pages

2. **Power BI Service**
   - Publish to Power BI Service
   - Share link (requires Microsoft account)

## Alternative: Python Dashboard

If Power BI is not available (macOS without Windows), use Plotly Dash:

```python
# dashboards/plotly_dashboard.py
import dash
from dash import dcc, html
import plotly.graph_objects as go
import pandas as pd

# Load data
df = pd.read_parquet("data/processed/retail_sales_clean.parquet")
forecast = pd.read_csv("data/predictions/forecast_latest.csv")
forecast['ds'] = pd.to_datetime(forecast['ds'])

app = dash.Dash(__name__)

# Create figure
fig = go.Figure()

# Confidence bands
fig.add_trace(go.Scatter(
    x=pd.concat([forecast['ds'], forecast['ds'][::-1]]),
    y=pd.concat([forecast['yhat_upper_95'], forecast['yhat_lower_95'][::-1]]),
    fill='toself',
    fillcolor='rgba(25,118,210,0.1)',
    line=dict(color='rgba(255,255,255,0)'),
    name='95% CI'
))

# Forecast line
fig.add_trace(go.Scatter(
    x=forecast['ds'],
    y=forecast['yhat'],
    mode='lines',
    name='Forecast',
    line=dict(color='#1976D2', width=2)
))

# Actual points
fig.add_trace(go.Scatter(
    x=df['ds'],
    y=df['y'],
    mode='markers',
    name='Actual',
    marker=dict(color='#212121', size=6)
))

fig.update_layout(
    title='Retail Sales Forecast - Food & Beverage Stores',
    template='plotly_white',
    hovermode='x unified'
)

app.layout = html.Div([
    html.H1("Retail Sales Forecasting Dashboard"),
    dcc.Graph(figure=fig),
    html.Div([
        html.H3("Model Performance"),
        html.P("MAPE: 3.2%"),
        html.P("Coverage: 87%"),
    ])
])

if __name__ == "__main__":
    app.run_server(debug=True, port=8050)
```

Run:
```bash
pip install dash plotly
python dashboards/plotly_dashboard.py
# Open http://localhost:8050
```

## Next Steps

1. [Deploy to GitHub Pages](07-DEPLOYMENT.md)
